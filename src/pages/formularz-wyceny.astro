---
import Header from "../components/Header.astro";
import Sidebar from "../components/Sidebar.astro";
---
<!DOCTYPE html>
<html lang="pl">
  <Header 
    title="Formularz wyceny | 41.pl" 
    description="Wyślij zapytanie o wycenę projektu. Administracja serwerów, tworzenie stron, programowanie. Odpowiadamy w ciągu 24 godzin."
  />
  <body>
    <div class="content">
      <Sidebar selectedItem="" />
      <nav class="main">
        <div class="container">
          <div class="back-nav-container">
            <a href="/" class="back-nav-button w-inline-block">
              <img src="/assets/back.svg" loading="lazy" alt="" class="back-nav-img" />
              <div>Powrót</div>
            </a>
          </div>
          <div class="content-container">
            <h1>Formularz wyceny</h1>
            
            <p class="lead">
              Opisz swój projekt lub potrzeby. Odpowiadamy w ciągu 24 godzin.
            </p>
            
            <div id="form-container">
              <form id="wycena-form" class="form-wycena">
                <div class="form-group">
                  <label for="nazwa" class="form-label">Imię lub nazwa firmy</label>
                  <input type="text" id="nazwa" name="nazwa" required class="form-input" placeholder="Jan Kowalski" />
                </div>
                
                <div class="form-group">
                  <label for="email" class="form-label">Adres email</label>
                  <input type="email" id="email" name="email" required class="form-input" placeholder="jan@example.pl" />
                </div>
                
                <div class="form-group">
                  <label for="opis" class="form-label">Opis projektu</label>
                  <textarea id="opis" name="opis" required class="form-textarea" rows="6" placeholder="Opisz czego potrzebujesz..."></textarea>
                  <div class="word-counter">
                    <span id="word-count">0</span> / 400 słów
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="plik" class="form-label">Załącznik (opcjonalnie, max 10 MB)</label>
                  <input type="file" id="plik" name="plik" class="form-file" accept=".pdf,.doc,.docx,.xls,.xlsx,.odt,.ods,.odp,.odg,.jpg,.jpeg,.png,.gif,.webp,.zip,.rar,.txt,.md" />
                  <div class="file-hint">Dozwolone formaty: PDF, DOC, XLS, ODT, ODS, JPG, PNG, ZIP, MD i inne.</div>
                  <div id="file-list" class="file-list"></div>
                </div>
                
                <button type="submit" id="submit-btn" class="button form-button">Wyślij zapytanie</button>
              </form>
            </div>
            
            <div id="form-success" class="form-message form-success" style="display: none;">
              <h3>Dziękujemy!</h3>
              <p class="lead">Twoje zgłoszenie zostało wysłane. Odpowiemy w ciągu 24 godzin.</p>
              <p class="lead">Potwierdzenie zostało wysłane na podany adres email.</p>
            </div>
            
            <div id="form-error" class="form-message form-error" style="display: none;">
              <h3>Wystąpił błąd</h3>
              <p class="lead" id="error-message">Spróbuj ponownie później.</p>
              <button onclick="location.reload()" class="button form-button">Spróbuj ponownie</button>
            </div>
            
          </div>
        </div>
      </nav>
    </div>
    
    <style>
      .form-wycena {
        display: flex;
        flex-direction: column;
        gap: 24px;
        max-width: 500px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .form-label {
        color: #fff;
        font-size: 14px;
        font-family: 'IBM Plex Mono', monospace;
        text-transform: uppercase;
        letter-spacing: 0.75px;
      }
      
      .form-input,
      .form-textarea {
        background-color: #1c1c1c;
        border: 1px solid #353535;
        border-radius: 8px;
        padding: 14px 16px;
        color: #fff;
        font-family: inherit;
        font-size: 16px;
        line-height: 24px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      
      .form-input:focus,
      .form-textarea:focus {
        outline: none;
        border-color: #555;
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
      }
      
      .form-input::placeholder,
      .form-textarea::placeholder {
        color: #666;
      }
      
      .form-textarea {
        resize: vertical;
        min-height: 120px;
      }
      
      .word-counter {
        font-size: 12px;
        color: #888;
        text-align: right;
        font-family: 'IBM Plex Mono', monospace;
      }
      
      .word-counter.over-limit {
        color: #ff6b6b;
      }
      
      .form-file {
        background-color: #1c1c1c;
        border: 1px dashed #353535;
        border-radius: 8px;
        padding: 14px 16px;
        color: #fff;
        font-family: inherit;
        font-size: 14px;
        cursor: pointer;
        transition: border-color 0.2s;
      }
      
      .form-file:hover {
        border-color: #555;
      }
      
      .form-file::file-selector-button {
        background-color: #353535;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        color: #fff;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
        margin-right: 12px;
        transition: background-color 0.2s;
      }
      
      .form-file::file-selector-button:hover {
        background-color: #454545;
      }
      
      .file-hint {
        font-size: 12px;
        color: #666;
        font-family: 'IBM Plex Mono', monospace;
      }
      
      .file-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
      }
      
      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #252525;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 13px;
        color: #ccc;
      }
      
      .file-item-name {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 300px;
      }
      
      .file-item-size {
        color: #888;
        font-size: 11px;
        margin-left: 12px;
      }
      
      .form-button {
        align-self: flex-start;
        margin-top: 8px;
        cursor: pointer;
      }
      
      .form-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .form-message {
        max-width: 500px;
        padding: 32px;
        border-radius: 12px;
      }
      
      .form-success {
        background-color: rgba(0, 200, 100, 0.1);
        border: 1px solid rgba(0, 200, 100, 0.3);
      }
      
      .form-error {
        background-color: rgba(255, 100, 100, 0.1);
        border: 1px solid rgba(255, 100, 100, 0.3);
      }
      
      .form-message h3 {
        margin-bottom: 16px;
      }
      
      .form-message .lead {
        margin-bottom: 12px;
      }
      
      @media screen and (max-width: 767px) {
        .form-wycena {
          max-width: 100%;
        }
        
        .form-message {
          max-width: 100%;
          padding: 24px;
        }
        
        .form-button {
          width: 100%;
          text-align: center;
        }
        
        .file-item-name {
          max-width: 180px;
        }
      }
    </style>
    
    <script>
      // Licznik slow
      const opisField = document.getElementById('opis');
      const wordCounter = document.getElementById('word-count');
      const wordCounterContainer = document.querySelector('.word-counter');
      const maxWords = 400;
      
      function countWords(text) {
        const trimmed = text.trim();
        if (trimmed === '') return 0;
        return trimmed.split(/\s+/).length;
      }
      
      opisField.addEventListener('input', function() {
        const count = countWords(this.value);
        wordCounter.textContent = count;
        
        if (count > maxWords) {
          wordCounterContainer.classList.add('over-limit');
        } else {
          wordCounterContainer.classList.remove('over-limit');
        }
      });
      
      // Wyswietlanie wybranego pliku
      const fileInput = document.getElementById('plik');
      const fileList = document.getElementById('file-list');
      
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
      
      fileInput.addEventListener('change', function() {
        fileList.innerHTML = '';
        
        if (this.files.length === 0) return;
        
        const file = this.files[0];
        
        if (file.size > 10 * 1024 * 1024) {
          alert('Plik "' + file.name + '" przekracza limit 10 MB');
          this.value = '';
          return;
        }
        
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = '<span class="file-item-name">' + file.name + '</span><span class="file-item-size">' + formatFileSize(file.size) + '</span>';
        fileList.appendChild(item);
      });
      
      // Wysylka formularza
      document.getElementById('wycena-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btn = document.getElementById('submit-btn');
        const formContainer = document.getElementById('form-container');
        const successMsg = document.getElementById('form-success');
        const errorMsg = document.getElementById('form-error');
        const errorText = document.getElementById('error-message');
        
        // Sprawdz limit slow
        const wordCount = countWords(opisField.value);
        if (wordCount > maxWords) {
          alert('Opis przekracza limit ' + maxWords + ' słów (aktualnie: ' + wordCount + ')');
          return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Wysyłanie...';
        
        const formData = new FormData();
        formData.append('nazwa', document.getElementById('nazwa').value);
        formData.append('email', document.getElementById('email').value);
        formData.append('opis', document.getElementById('opis').value);
        
        const fileField = document.getElementById('plik');
        if (fileField.files.length > 0) {
          formData.append('plik', fileField.files[0]);
        }
        
        try {
          const response = await fetch('https://api.41.pl/wycena.php', {
            method: 'POST',
            headers: {
              'X-API-Key': '41pl_a7Kx9mP2qL5vN8wR'
            },
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            formContainer.style.display = 'none';
            successMsg.style.display = 'block';
          } else {
            formContainer.style.display = 'none';
            errorText.textContent = result.error || 'Wystąpił nieoczekiwany błąd.';
            errorMsg.style.display = 'block';
          }
        } catch (err) {
          formContainer.style.display = 'none';
          errorText.textContent = 'Błąd połączenia. Sprawdź internet i spróbuj ponownie.';
          errorMsg.style.display = 'block';
        }
      });
    </script>
  </body>
</html>
